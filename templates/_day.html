{% set is_past = date < today.isoformat() %}
<div id="day-{{ date }}" class="bg-white p-4 rounded shadow h-full flex flex-col"
  {% if not is_past %}
    hx-get="/marja/day/{{ date }}"
    hx-trigger="every 30s"
    hx-swap="outerHTML"
  {% endif %}
>
  <h2 class="font-semibold text-lg">{{ date | format_dutch_date }}</h2>

  {% set parts_of_day = {'Ochtend': 'morning', 'Middag': 'afternoon', 'Avond': 'evening'} %}

  <div class="mt-2 space-y-4 flex-grow">
    {% for dutch, english in parts_of_day.items() %}
      <div class="flex-1">
        <h3 class="font-semibold text-sm text-gray-600">{{ dutch }}</h3>
        {% set time_slot_visitors = visitors.get(english, []) %}
        {% set has_active = time_slot_visitors | selectattr('status', 'equalto', 'active') | list | length > 0 %}

        {# Show active visitors first #}
        {% for visitor in time_slot_visitors if visitor.status == 'active' %}
          <div class="text-gray-700 flex items-center justify-between">
            <span>• {{ visitor.visitor }}</span>
            {% if not is_past and english != 'evening' %}
            <button
              class="text-red-500 hover:underline text-sm"
              hx-post="/marja/delete_visitor/{{ visitor.id }}"
              hx-confirm="Weet je zeker dat je dit bezoek wilt annuleren?"
              hx-target="#day-{{ date }}"
              hx-swap="outerHTML"
            >❌</button>
            {% endif %}
          </div>
        {% endfor %}

        {# Then show canceled visitors #}
        {% for visitor in time_slot_visitors if visitor.status == 'canceled' %}
          <div class="text-gray-700">
            <span class="line-through text-gray-400">• {{ visitor.visitor }} (geannuleerd)</span>
          </div>
        {% endfor %}

        {# Show add form if not evening, not past, and no active visitor #}
        {% if not is_past and english != 'evening' and not has_active %}
          {% with english=english, date=date %}
            {% include "_add_visitor_form.html" %}
          {% endwith %}
        {% elif not time_slot_visitors and not is_past and english != 'evening' %}
          {% with english=english, date=date %}
            {% include "_add_visitor_form.html" %}
          {% endwith %}
        {% elif not time_slot_visitors %}
          <p class="text-gray-400 text-sm italic">Geen bezoeker</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>
